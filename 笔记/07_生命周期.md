# Nest应用生命周期执行顺序

```markdown
                                        	启动一个Nest项目的时候
                                                	↓ 
                                        	首先会递归解析Module依赖
                                                	↓
                                        	扫描其中的provider和controller
                                                	↓
                                        		注入它的依赖
                                                	↓
                                        	全部解析完后,会监听网络端口,开始处理请求.

这个过程中,Nest暴露出了一些生命周期钩子:

1. 递归初始化Module时,会依次调用Module内的Controller/Provider的onModuleInit方法,然后再调用Module的onModuleInit方法.
2. 所有Module初始化完成之后,会再依次调用模块内的Controller/Provider的onApplicationBootstrap方法,然后调用Module的onApplicationBootstrap方法.
3. 监听网络端口.
4. nest运行成功.

# 这个过程中,`onModuleInit`/`onApplicationBootstrap`都是我们可以实现的生命周期方法.
```

## 应用初始化阶段的生命周期钩子

> # onModuleInit和onApplicationBootstrap

1. 创建项目

> nest new 08_生命周期 -s -g -p pnpm

2. 生成两个测试模块 test1和test2

> nest generate resource test1 --no-spec
>
> nest generate resource test2 --no-spec

3. Nest提供了下面OnModuleInit和IOnApplicationBootstrap这两个接口,我们想要使用时需要先实现它.

> ```js
> // OnModuleInit
> export interface OnModuleInit{
>     onModuleInit(): any;
> }
> 
> // OnApplicationBootstrap
> export interface OnApplicationBootstrap{
>     onApplicationBootstrap(): any;
> }
> ```

4. 在测试模块中的controller/service/module实现OnModuleInit接口.

> test1模块

- test1.module.ts

> ```ts
> import { Module, OnApplicationBootstrap, OnModuleInit } from '@nestjs/common';
> import { Test1Service } from './test1.service';
> import { Test1Controller } from './test1.controller';
> 
> @Module({
>   controllers: [Test1Controller],
>   providers: [Test1Service],
> })
> export class Test1Module implements OnModuleInit, OnApplicationBootstrap {
>   onModuleInit() {
>     console.log('test1 module OnModuleInit 执行了');
>   }
> 
>   onApplicationBootstrap() {
>     console.log('test1 module onApplicationBootstrap 执行了');
>   }
> }
> ```

- test1.controller.ts

> ```ts
> import {
>   Controller,
>   OnModuleInit,
>   OnApplicationBootstrap,
> } from '@nestjs/common';
> import { Test1Service } from './test1.service';
> 
> @Controller('test1')
> export class Test1Controller implements OnModuleInit, OnApplicationBootstrap {
>   constructor(private readonly test1Service: Test1Service) {}
> 
>   onModuleInit() {
>     console.log('test1 controller onModuleInit 执行了');
>   }
> 
>   onApplicationBootstrap() {
>     console.log('test1 controller onApplicationBootstrap 执行了');
>   }
> }
> ```

- test1.service.ts

> ```ts
> import {
>   Injectable,
>   OnApplicationBootstrap,
>   OnModuleInit,
> } from '@nestjs/common';
> 
> @Injectable()
> export class Test1Service implements OnModuleInit, OnApplicationBootstrap {
>   onModuleInit() {
>     console.log('test1 service OnModuleInit 执行了');
>   }
> 
>   onApplicationBootstrap() {
>     console.log('test1 service onApplicationBootstrap 执行了');
>   }
> }
> ```

> test2模块

- test2.module.ts

> ```ts
> import { Module, OnApplicationBootstrap, OnModuleInit } from '@nestjs/common';
> import { Test2Service } from './test2.service';
> import { Test2Controller } from './test2.controller';
> 
> @Module({
>   controllers: [Test2Controller],
>   providers: [Test2Service],
> })
> export class Test2Module implements OnModuleInit, OnApplicationBootstrap {
>   onModuleInit() {
>     console.log('test2 module OnModuleInit 执行了');
>   }
> 
>   onApplicationBootstrap() {
>     console.log('test2 module OnApplicationBootstrap 执行了');
>   }
> }
> ```

- test2.controller.ts

> ```ts
> import {
>   Controller,
>   OnApplicationBootstrap,
>   OnModuleInit,
> } from '@nestjs/common';
> import { Test2Service } from './test2.service';
> 
> @Controller('test2')
> export class Test2Controller implements OnModuleInit, OnApplicationBootstrap {
>   constructor(private readonly test2Service: Test2Service) {}
> 
>   onModuleInit() {
>     console.log('test2 controller OnModuleInit 执行了');
>   }
> 
>   onApplicationBootstrap() {
>     console.log('test2 controller OnApplicationBootstrap 执行了');
>   }
> }
> ```

- test2.service.ts

> ```ts
> import {
>   Injectable,
>   OnApplicationBootstrap,
>   OnModuleInit,
> } from '@nestjs/common';
> 
> @Injectable()
> export class Test2Service implements OnModuleInit, OnApplicationBootstrap {
>   onModuleInit() {
>     console.log('test2 service OnModuleInit 执行了');
>   }
> 
>   onApplicationBootstrap() {
>     console.log('test2 service OnApplicationBootstrap 执行了');
>   }
> }
> ```

5. 启动项目查看打印日志, 这就是onModuleInit和onApplicationBootstrap生命周期的执行顺序.

```markdown
test1 controller onModuleInit 执行了
test1 service OnModuleInit 执行了
test1 module OnModuleInit 执行了
test2 controller OnModuleInit 执行了
test2 service OnModuleInit 执行了
test2 module OnModuleInit 执行了
test1 controller onApplicationBootstrap 执行了
test1 service onApplicationBootstrap 执行了
test1 module onApplicationBootstrap 执行了
test2 controller OnApplicationBootstrap 执行了
test2 service OnApplicationBootstrap 执行了
test2 module OnApplicationBootstrap 执行了
```

## 应用销毁阶段的生命周期钩子

>#### onModuleDestroy / beforeApplicationShutdown / onApplicationShutdown

> Nest应用销毁时:
>
> 1. 会先调用每个Module中Controller/Provider中的onModuleDestroy方法.
>
> 2. 然后再调用每个Module中的onModuleDestroy方法.
> 3. 调用每个Module中Controller/Provider中的beforeApplicationShutdown方法.
> 4. 调用每个Module中的beforeApplicationShutdown方法.
> 5. 停止监听网络端口.
> 6. 调用每个Module中Controller/Provider的onApplicationShutdown方法.
> 7. 调用每个Module中的onApplicationShutdown方法.
> 8. 停止进程.

1. onModuleDestroy和beforeApplicationShutdown的区别.

```ts
// onModuleDestroy
export interface OnModuleDestroy {
    onModuleDestroy(): any;
} 

// beforeApplicationShutdown是可以拿到signal系统信号的,比如SIGTERM,这些终止信号是从别的进程传递过来,让它做一些销毁的事情,比如用k8s管理容器的时候,可以已通过这个信号来通知它.
export interface BeforeApplicationShutdown {
    beforeApplicationShutdown(signal?: string): any;
}
```

2. 在测试模块中的controller/service/module实现onModuleDestroy beforeApplicationShutdown onApplicationShutdown接口.

- test1.module.ts

```ts
import {
  BeforeApplicationShutdown,
  Module,
  OnApplicationBootstrap,
  OnApplicationShutdown,
  OnModuleDestroy,
  OnModuleInit,
} from '@nestjs/common';
import { Test1Service } from './test1.service';
import { Test1Controller } from './test1.controller';

@Module({
  controllers: [Test1Controller],
  providers: [Test1Service],
})
export class Test1Module
  implements
    OnModuleInit,
    OnApplicationBootstrap,
    OnModuleDestroy,
    BeforeApplicationShutdown,
    OnApplicationShutdown
{
  onModuleInit() {
    console.log('test1 module OnModuleInit 执行了');
  }

  onApplicationBootstrap() {
    console.log('test1 module onApplicationBootstrap 执行了');
  }

  onModuleDestroy() {
    console.log('test1 module onModuleDestroy 执行了');
  }

  onApplicationShutdown(signal?: string) {
    console.log('test1 module onApplicationShutdown 执行了 signal:' + signal);
  }

  beforeApplicationShutdown(signal?: string) {
    console.log(
      'test1 module beforeApplicationShutdown 执行了 signal:' + signal,
    );
  }
}
```

- test1.controller.ts

```ts
import {
  Controller,
  OnModuleInit,
  OnApplicationBootstrap,
  OnModuleDestroy,
  BeforeApplicationShutdown,
  OnApplicationShutdown,
} from '@nestjs/common';
import { Test1Service } from './test1.service';

@Controller('test1')
export class Test1Controller
  implements
    OnModuleInit,
    OnApplicationBootstrap,
    OnModuleDestroy,
    BeforeApplicationShutdown,
    OnApplicationShutdown
{
  constructor(private readonly test1Service: Test1Service) {}

  onModuleInit() {
    console.log('test1 controller onModuleInit 执行了');
  }

  onApplicationBootstrap() {
    console.log('test1 controller onApplicationBootstrap 执行了');
  }

  onModuleDestroy() {
    console.log('test1 controller onModuleDestroy 执行了');
  }

  onApplicationShutdown(signal?: string) {
    console.log(
      'test1 controller onApplicationShutdown 执行了 signal:' + signal,
    );
  }

  beforeApplicationShutdown(signal?: string) {
    console.log(
      'test1 controller beforeApplicationShutdown 执行了 signal:' + signal,
    );
  }
}
```

- test1.service.ts

```ts
import {
  BeforeApplicationShutdown,
  Injectable,
  OnApplicationBootstrap,
  OnApplicationShutdown,
  OnModuleDestroy,
  OnModuleInit,
} from '@nestjs/common';

@Injectable()
export class Test1Service
  implements
    OnModuleInit,
    OnApplicationBootstrap,
    OnModuleDestroy,
    BeforeApplicationShutdown,
    OnApplicationShutdown
{
  onModuleInit() {
    console.log('test1 service OnModuleInit 执行了');
  }

  onApplicationBootstrap() {
    console.log('test1 service onApplicationBootstrap 执行了');
  }

  onModuleDestroy() {
    console.log('test1 service onModuleDestroy 执行了');
  }

  onApplicationShutdown(signal?: string) {
    console.log('test1 service onApplicationShutdown 执行了 signal:' + signal);
  }

  beforeApplicationShutdown(signal?: string) {
    console.log(
      'test1 service beforeApplicationShutdown 执行了 signal:' + signal,
    );
  }
}
```

> test2模块

- test2.module.ts

```ts
import {
  BeforeApplicationShutdown,
  Module,
  OnApplicationBootstrap,
  OnApplicationShutdown,
  OnModuleDestroy,
  OnModuleInit,
} from '@nestjs/common';
import { Test2Service } from './test2.service';
import { Test2Controller } from './test2.controller';

@Module({
  controllers: [Test2Controller],
  providers: [Test2Service],
})
export class Test2Module
  implements
    OnModuleInit,
    OnApplicationBootstrap,
    OnModuleDestroy,
    BeforeApplicationShutdown,
    OnApplicationShutdown
{
  onModuleInit() {
    console.log('test2 module OnModuleInit 执行了');
  }

  onApplicationBootstrap() {
    console.log('test2 module OnApplicationBootstrap 执行了');
  }

  onModuleDestroy() {
    console.log('test2 module onModuleDestroy 执行了');
  }

  onApplicationShutdown(signal?: string) {
    console.log('test2 module onApplicationShutdown 执行了 signal:' + signal);
  }

  beforeApplicationShutdown(signal?: string) {
    console.log(
      'test2 module beforeApplicationShutdown 执行了 signal:' + signal,
    );
  }
}
```

- test2.controller.ts

```ts
import {
  BeforeApplicationShutdown,
  Controller,
  OnApplicationBootstrap,
  OnApplicationShutdown,
  OnModuleDestroy,
  OnModuleInit,
} from '@nestjs/common';
import { Test2Service } from './test2.service';

@Controller('test2')
export class Test2Controller
  implements
    OnModuleInit,
    OnApplicationBootstrap,
    OnModuleDestroy,
    BeforeApplicationShutdown,
    OnApplicationShutdown
{
  constructor(private readonly test2Service: Test2Service) {}

  onModuleInit() {
    console.log('test2 controller OnModuleInit 执行了');
  }

  onApplicationBootstrap() {
    console.log('test2 controller OnApplicationBootstrap 执行了');
  }

  onModuleDestroy() {
    console.log('test2 controller onModuleDestroy 执行了');
  }

  onApplicationShutdown(signal?: string) {
    console.log(
      'test2 controller onApplicationShutdown 执行了 signal:' + signal,
    );
  }

  beforeApplicationShutdown(signal?: string) {
    console.log(
      'test2 controller beforeApplicationShutdown 执行了 signal:' + signal,
    );
  }
}
```

- test2.service.ts

```ts
import {
  BeforeApplicationShutdown,
  Injectable,
  OnApplicationBootstrap,
  OnApplicationShutdown,
  OnModuleDestroy,
  OnModuleInit,
} from '@nestjs/common';

@Injectable()
export class Test2Service
  implements
    OnModuleInit,
    OnApplicationBootstrap,
    OnModuleDestroy,
    BeforeApplicationShutdown,
    OnApplicationShutdown
{
  onModuleInit() {
    console.log('test2 service OnModuleInit 执行了');
  }

  onApplicationBootstrap() {
    console.log('test2 service OnApplicationBootstrap 执行了');
  }

  onModuleDestroy() {
    console.log('test2 service onModuleDestroy 执行了');
  }

  onApplicationShutdown(signal?: string) {
    console.log('test2 service onApplicationShutdown 执行了 signal:' + signal);
  }

  beforeApplicationShutdown(signal?: string) {
    console.log(
      'test2 service beforeApplicationShutdown 执行了 signal:' + signal,
    );
  }
}
```

3. 测试

> 在main.ts中写一个定时器,3秒后调用app.close触发销毁 (app.close只是触发销毁逻辑,但不会真正的退出进程)

```ts
// main.ts
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  await app.listen(process.env.PORT ?? 3000);

  setTimeout(() => {
    app.close();
  }, 3000);
}

bootstrap();
```

4. 启动项目查看打印日志, 这就是onModuleDestroy / beforeApplicationShutdown / onApplicationShutdown生命周期的执行顺序.

```markdown
test2 controller onModuleDestroy 执行了
test2 service onModuleDestroy 执行了
test2 module onModuleDestroy 执行了
test1 controller onModuleDestroy 执行了
test1 service onModuleDestroy 执行了
test1 module onModuleDestroy 执行了
test2 controller beforeApplicationShutdown 执行了 signal:undefined
test2 service beforeApplicationShutdown 执行了 signal:undefined
test2 module beforeApplicationShutdown 执行了 signal:undefined
test1 controller beforeApplicationShutdown 执行了 signal:undefined
test1 service beforeApplicationShutdown 执行了 signal:undefined
test1 module beforeApplicationShutdown 执行了 signal:undefined
test2 controller onApplicationShutdown 执行了 signal:undefined
test2 service onApplicationShutdown 执行了 signal:undefined
test2 module onApplicationShutdown 执行了 signal:undefined
test1 controller onApplicationShutdown 执行了 signal:undefined
test1 service onApplicationShutdown 执行了 signal:undefined
test1 module onApplicationShutdown 执行了 signal:undefined
```